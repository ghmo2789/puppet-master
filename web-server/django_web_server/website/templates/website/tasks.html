<html>
  <head>
      {% load static %}
      <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
      <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.css' %}">
      <link rel="stylesheet" href="{% static 'w3/w3.css' %}">
      <link rel="stylesheet" href="{% static 'website/website.css' %}">
    
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
      
      
  </head>
  <body class="bg-dark text-white">
    <!-- Navbar -->
    {% block nav %}{% include 'website/navbar.html' %}{% endblock nav %}

    <!-- Heading -->
    <div class="w3-container"> 
      <h1>Task History</h1>
    </div>

    <!-- Task filter -->
    <div class="w3-container">
      <form method="GET">
        {{ tasks.form.client_id__ip }}
        {{ tasks.form.status }}
        {{ tasks.form.task_type }}
        <button class="w3-button w3-black" type="submit">Apply Filter</button>
      </form>
    </div>


    <!-- Tasks table -->
    <div class="w3-container table-wrapper-scroll-y w3-padding-16" style="height:500px; overflow: auto"> 
        <table class="table table-dark table-striped table-hover mb-0">
            <tr style="background-color: black;"> 
              <td><input type="checkbox" name="select_all" value="1" id="master_checkbox" onclick="select_all()"></td>
              <td>Client IP</td>
              <td>Start Time</td>
              <td>Status</td>
              <td>Task Type</td>
              <td>Task Info</td>
            </tr>
            <form method="post" >
            {% csrf_token %}
            {% for i in tasks.qs%}
            <tr>
                <td><input type="checkbox" name="select" value="{{i.id}}" id="{{i.id}}"></td> 
                <td>{{i.client_id.ip}}</td>
                <td>{{i.start_time}}</td>
                <td>{{i.status}}</td>
                <td>{{i.task_type}}</td>
                <td>{{i.task_info}}</td>
            </tr>
            {% endfor %}
        </table>
      </div>

      <!-- Kill task selection -->
      <div class="w3-container w3-padding-16" id="submit" hidden>
        <div class="w3-container w3-quarter w3-center" style="float: right">
          <input class ="w3-button w3-block w3-black", type="submit", value="Kill Task" id="send_kill"> 
        </div>
      </div>
      </form>

      <!-- Test notifications -->
      <div id='notifications-popup'>
        <ul id='notice-list'>
        </ul>
      </div>

      <div class="toast fade show" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
            <svg class="bd-placeholder-img rounded me-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" preserveAspectRatio="xMidYMid slice" focusable="false"><rect width="100%" height="100%" fill="#007aff"></rect></svg>
        
            <strong class="me-auto">Bootstrap</strong>
            <small class="text-muted">11 mins ago</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            Hello, world! This is a toast message.
          </div>
        </div>

    <script type="text/javascript">

      // Initialize data for javascript
      let data = [];
      {% for i in tasks.qs %}
        data.push({{i.id}});
      {% endfor %}

      // Event listeners
      for(let i = 0; i < data.length; i++) {
        document.getElementById(data[i]).addEventListener("click", toggleSubmit)
      }

      toggleSubmit();

      function toggleSubmit(){
        submit_element = document.getElementById("submit") 
        checked = false; 
        for(let i = 0; i < data.length; i++) {
          if(document.getElementById(data[i]).checked) {
            checked = true;
          }
        }
        if(checked){
          submit_element.hidden = false;
        } else {
          submit_element.hidden = true; 
        }
      }
  
      function select_all(){
        if(document.getElementById("master_checkbox").checked) {
          for(let i = 0; i < data.length; i++) {
            document.getElementById(data[i]).checked = true; 
          }
          toggleSubmit();
        } else {
          for(let i = 0; i < data.length; i++) {
            document.getElementById(data[i]).checked = false; 
          }
          toggleSubmit();
        }
      }

      const csrf_token = '{{ csrf_token }}';
      
      function get_updated_tasks(){
        fetch('updated_task', {
              method: 'GET',
              credentials: 'same-origin',
              headers:{
                //'Accept': 'application/json',
                //'X-Requested-With': 'XMLHttpRequest', 
                'X-CSRFToken': csrf_token, 
              }}).then((response) => response.json())
                  .then((data) => {
                    console.log(data)
                    tasks_list = data.tasks
                    for (i = 0; i < tasks_list.length; i++) {
                      var task = tasks_list[i];
                      var text = 'Task ' + task.task_id + ' new status ' + task.new_status;
                      var ul = document.getElementById("notice-list");
                      var li = document.createElement("li");
                      li.appendChild(document.createTextNode(text));
                      ul.appendChild(li);
                    }
                  });
        }

        setInterval(get_updated_tasks, 5000);

    </script>
  </body> 
</html>