# Client

Client application that is supposed to be installed on target hosts that should be included in the client network.

The client application is intended to be run on computers that wish to be added to the network of controllable hosts.
The client application must be built on the same type of operating system as the binary is intended to be run at. For
example, if wanting to add a Linux host in the network, the client application must be built on a Linux machine. Then
vice versa for Windows and macOS.

## Install Rust

Before the Client application can be built, Rust must be installed by running the following command:

```
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

Fore more information, see official documentation [here](https://www.rust-lang.org/tools/install).

## How to build and run application

1. Before building the client application, the environment variables
   in [``client/.cargo/config.toml``](.cargo/config.toml)
   must be set. Inthis file, communication protocol, URL/IP address to the control server, obfuscation key for UDP
   traffic, client polling time and SSH Spread payload is set.

2. When the variables are set, the client application can be built by run the following commands:

```
cd client/
cargo run --release
```

If not building for a release and want to test the application with debug output, remove the ``--release`` flag.

Note that if wanting to make changes to the configuration files between compilations, you may be required to remove your
previous compiled version. To do this, remove the generated ``client/target`` directory.



## How to build and run application in a docker container

1. Before building the client application, the environment variables in
   ``client/.env`` must be set. In this file, communication protocol and URL/IP address to the control server is set.
   For more documentation on what the variables do, see [.cargo/config.toml](.cargo/config.toml).

2. When the variables are set, the container can be build and started with the
   script [start-docker-container.sh](start-docker-container.sh). To use the script, set it as executable
   with ``chmod +x start-docker-container.sh`` and then run it with ``./start-docker-container.sh``.

## How to build with static linking for Linux

The application can be built with static linking on Linux to allow the application to run on Linux hosts without any
dependecies.

1. Update ``rustup``

```
rustup update
```

2. Install dependencies

```
sudo apt-get install pkg-config musl-tools libssl-dev
```

3. Add the Linux MUSL toolchain to rustup

```
rustup target add x86_64-unknown-linux-musl
```

4. Build the application for ``x86_64-unknown-linux-musl``

```
cargo build --target x86_64-unknown-linux-musl --release
```

## How to run tests locally

If testing the client locally, you must first set the configuration file located in ``client/.cargo/config.toml`` as
following:

```
# Environment variables used during compile time
[env]
# Defines what protocol the client should use, set to either "https" or "udp"
PROTOCOL = "https"

# If using HTTPS as protocol, this defines the control server URL.
# Note that https:// should be used if traffic over https is desired
CONTROL_SERVER_URL = "http://127.0.0.1:8080"

# If using UDP as protocol, this defines the IP and port used by the control server
REMOTE_HOST = "127.0.0.1"
REMOTE_PORT = "65500"
```

To run the tests locally, you must also run the mock server that the client is using for testing. You can run the tests
with the following commands:

```
cd client/
python test/mock_server.py &  

cargo test
```

Make sure to let the mock server process start properly before running the tests with cargo!

If wanting to test the client with UDP communication, change the config to ``PROTOCOL= "udp"`` and run the mock server
and client with:

```
python test/mock_server.py --udp &

cargo run
```

Note that unit testing is not supported when running with UDP.

### How to generate code coverage

To be able to generate a test code coverage report, the following tools must first be installed:

``` 
# Installs llvm-tools-preview component
rustup component add llvm-tools-preview

# Installs Grcov
cargo install grcov
```

When the tools are installed, the test coverage report can be generated by the following commands

```
# Generates coverage files 
CARGO_INCREMENTAL=0 RUSTFLAGS='-Cinstrument-coverage' LLVM_PROFILE_FILE='cargo-test-%p-%m.profraw' cargo 

# Create folder for HTML coverage report
mkdir -p target/coverage/html 

# Generates HTML report 
grcov . --binary-path ./target/debug/deps/ -s . -t html --branch --ignore-not-existing --ignore '../*' --ignore "/*" -o target/coverage/html
```

When the report is generated, it can be examined by opening ``target/coverage/html/index.html`` in a web browser. 